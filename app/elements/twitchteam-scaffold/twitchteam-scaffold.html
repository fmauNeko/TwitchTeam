<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../../bower_components/core-drawer-panel/core-drawer-panel.html">
<link rel="import" href="../../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../../bower_components/core-item/core-item.html">
<link rel="import" href="../../bower_components/core-menu/core-menu.html">
<link rel="import" href="../../bower_components/core-menu/core-submenu.html">
<link rel="import" href="../../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../twitchteam-broadcaster/twitchteam-broadcaster.html">

<polymer-element name="twitchteam-scaffold" attributes="label responsiveWidth">
  <template>
    <link rel="stylesheet" href="twitchteam-scaffold.css">
    <core-drawer-panel id="drawerPanel" narrow="{{narrow}}" drawerWidth="320px" responsiveWidth="{{responsiveWidth}}">
      <core-header-panel id="mainHeaderPanel" main mode="{{narrow ? 'waterfall' : 'cover'}}" shadow>
        <core-toolbar class="{{ {'medium-tall' : !narrow} | tokenList }}">
          <content select=".menuButton" on-tap="{{togglePanel}}">
            <core-icon-button class="menuButton fallback" icon="menu"></core-icon-button>
          </content>
          <div hidden?="{{!narrow}}">{{item.label}}</div>
          <content select=".sourceButton" on-tap="{{viewSourceAction}}">
            <core-icon-button class="sourceButton fallback" icon="launch"></core-icon-button>
          </content>
        </core-toolbar>
        <div id="card" on-transitionend="{{cardTransitionDone}}" hidden?="{{!item}}">
          <div class="element-label" hidden?="{{narrow}}">{{item.label}}</div>
          <div horizontal layout>
            <div flex><iframe id="streamPlayer" src="//www.twitch.tv/{{broadcaster}}/embed" frameborder="0" scrolling="no" width="100%"></iframe></div>
            <div><iframe id="streamChat" src="http://www.twitch.tv/{{broadcaster}}/chat?popout=" frameborder="0" scrolling="no" width="350"></iframe></div>
          </div>
        </div>
      </core-header-panel>
      <core-header-panel drawer>
        <core-toolbar class="{{ {'medium-tall' : !narrow} | tokenList }}">
          <div class="bottom main-label fit">{{label}}</div>
        </core-toolbar>
        <core-menu id="menu" on-core-select="{{menuSelect}}">
          <content></content>
        </core-menu>
      </core-header-panel>
    </core-drawer-panel>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({
        responsiveWidth: '860px',
        broadcaster: '',

        ready: function() {
          window.addEventListener('hashchange', this.updateBroadcasterName.bind(this));
          window.addEventListener('resize', this.updateStreamHeight.bind(this));
        },

        domReady: function() {
          this.async(function() {
            this.updateBroadcasterName();
          }, null, 300);
        },

        updateBroadcasterName: function() {
          var route = window.location.hash.slice(1);
          for (var i = 0, item; item = this.$.menu.items[i]; i++) {
            if (item.getAttribute('tag') === route) {
              this.$.menu.selected = i;
              return;
            }
          }
          this.$.menu.selected = this.$.menu.selected || 0;
        },

        menuSelect: function(e, detail) {
          if (detail.isSelected) {
            this.item = detail.item;
            if (this.item.children.length) {
              this.item.selected = 0;
            }
            this.item.tag = this.item.getAttribute('tag');
            this.broadcaster = this.item.tag;
            window.location.hash = this.item.tag;
            if (this.narrow) {
              this.$.drawerPanel.closeDrawer();
            } else {
              this.animateCard();
            }
          }
        },

        animateCard: function() {
          this.$.card.classList.remove('move-up');
          this.$.card.style.display = 'none';
          this.async(function() {
            this.$.card.style.display = 'block';
            this.moveCard(this.$.mainHeaderPanel.offsetHeight);
            this.async(function() {
              this.$.card.classList.add('move-up');
              this.moveCard(null);
            }, null, 300);
          });
        },

        moveCard: function(y) {
          var s = this.$.card.style;
          s.webkitTransform = s.transform =
            y ? 'translate3d(0, ' + y + 'px,0)' : '';
        },

        cardTransitionDone: function() {
          if (this.$.card.classList.contains('move-up')) {
            this.$.card.classList.remove('move-up');
          }

          this.updateStreamHeight();
        },

        togglePanel: function() {
          this.$.drawerPanel.togglePanel();
        },

        updateStreamHeight: function() {
          var newHeight = this.$.streamPlayer.offsetWidth * 9.0 / 16.0 + 30.25;
          this.$.streamPlayer.height = newHeight;
          this.$.streamChat.height = newHeight;
        },

        viewSourceAction: function() {
          window.open('view-source:' + this.contentWindow.location.href,
            this.item.tag);
        }
      });
    })();
  </script>
</polymer-element>
